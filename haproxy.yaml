apiVersion: v1
kind: ServiceAccount
metadata:
  name: haproxy
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: haproxy-sync
  namespace: default
rules:
- apiGroups:
  - "discovery.k8s.io"
  resources:
  - endpointslices
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: haproxy-haproxy-sync
  namespace: default
subjects:
  - kind: ServiceAccount
    name: haproxy
roleRef:
  kind: Role
  name: haproxy-sync
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: default
  name: haproxy
data:
  haproxy.cfg: |
    global
      log stdout format raw local0
      stats socket /tmp/admin.sock mode 600 level admin expose-fd listeners
      stats timeout 30s
      master-worker

    defaults
      log global
      mode  http
      option  httplog
      option  dontlognull
      option  redispatch
      timeout connect 5000
      timeout client  500000
      timeout server  500000

    resolvers k8s
      parse-resolv-conf
      hold other 10s
      hold refused 10s
      hold nx 10s
      hold timeout 10s
      hold valid 10s
      hold obsolete 10s

    peers haproxy-peers
      #peer "$HOSTNAME" "$MY_POD_IP":3000
      peer "$HAPROXY_PEERNAME" 0.0.0.0:3000

    # we enable the DataPlaneAPI to allow us managing the HAProxy configuration dynamically via HTTP REST APIs
    # docs: https://www.haproxy.com/documentation/dataplaneapi/enterprise/
    # dataplaneapi usage: https://github.com/haproxytech/dataplaneapi
    program api
      command sh -c "HAPROXY_CFGFILES='' /usr/bin/dataplaneapi -f=/etc/haproxy/dataplaneapi.hcl"
      # avoids restarting the DataPlaneAPI each time HAProxy reloads
      no option start-on-reload

    frontend front-session
      bind 0.0.0.0:8080
      option httplog
      default_backend back-session

    backend back-session
      balance uri depth 4
      hash-type consistent djb2

      stick-table type string len 32 size 1M peers haproxy-peers srvkey addr
      stick match capture.req.uri,field(4,/)
      stick store-response capture.req.uri,field(4,/)
      #option httpchk GET /
      # see: http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#4-server-template
      server-template srv 3 sticky-backend.default.svc.cluster.local:80 check inter 1s resolvers k8s init-addr none

  dataplaneapi.hcl: |
    dataplaneapi {
      host = "127.0.0.1"
      port = 5555
      user "admin" {
        insecure = true
        password = "a1db9e7de13e2552fe95fc2f8e9f45b3513e1b22"
      }
    }

    haproxy {
      config_file = "/etc/haproxy/haproxy.cfg"
      haproxy_bin = "/usr/local/sbin/haproxy"
      reload {
        reload_delay = 1
        reload_cmd  = "kill -SIGUSR2 1"
        restart_cmd = "kill -SIGUSR2 1"
      }
    }

    log_targets = [
      {
        log_level = "trace"
      },
    ]
---
apiVersion: v1
kind: Service
metadata:
  name: haproxy
  namespace: default
  labels:
    app: haproxy
    tier: backend
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - name: haproxy
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: haproxy
    tier: backend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: haproxy
  namespace: default
  labels:
    app: haproxy
    tier: backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: haproxy
      tier: backend
  template:
    metadata:
      labels:
        app: haproxy
        tier: backend
    spec:
      serviceAccountName: haproxy
      initContainers:
      - name: copy
        image: busybox
        command: ["sh", "-c", 'cp /source/* /etc/haproxy && echo -n "$MY_POD_IP" | base64 | xxd -p -l 16 | tr -d "[:blank:]" > /etc/haproxy/peername']
        env:
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - mountPath: /source
          name: haproxy-config-ro-volume
        - mountPath: /etc/haproxy
          name: haproxy-config-rw-volume
      containers:
      - name: haproxy-peer-sync
        image: "damdo/k8s-haproxy-peer-sync:0.0.1"
        command:
        - ./k8s-haproxy-peer-sync
        - "--service=haproxy"
        - "--namespace=default"
        - "--user=admin"
        - "--password=a1db9e7de13e2552fe95fc2f8e9f45b3513e1b22"
        - "--data-plane-api-address=127.0.0.1:5555"
        - "--peer-port=3000"
        - "--peer-section-name=haproxy-peers"
        env:
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
      - name: debug
        image: "damdo/utilpine:3.14.2-20211023173401-4921f56"
        command:
        - sleep
        - infinity
      - name: haproxy
        # the haproxytech version of haproxy already has the DataplaneAPI built in
        image: "haproxytech/haproxy-alpine:2.4.8"
        command: ["/bin/sh","-c"]
        args: [ 'export HAPROXY_PEERNAME="$(cat /etc/haproxy/peername | tr -d "\n")" && haproxy -L "$(cat /etc/haproxy/peername | tr -d "\n")" -f /usr/local/etc/haproxy/haproxy.cfg' ]
        env:
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        ports:
        - containerPort: 8080
        - containerPort: 5555
        - containerPort: 3000
        volumeMounts:
          - mountPath: /etc/haproxy
            name: haproxy-config-rw-volume
            readOnly: false
      volumes:
        - name: haproxy-config-rw-volume
          emptyDir: {}
        - name: haproxy-config-ro-volume
          configMap:
            name: haproxy
